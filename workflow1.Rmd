---
title: "rangers"
author: "Thais Vasconcelos"
date: "2/24/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
setwd("~/Desktop/rangers")
# rm(list=ls())
```

This repo contains some miscellaneous functions and workflows to help extracting environmental variables from distribution points, perform phylogenetic regressions and visualize the distribution of lineages with specific traits by mapping them in space. 

This repo is not formated as an R package. To use its functionalities, you have to download the repo as a folder and then set you working directory as the **rangers** folder in  your computer.

## 1. Habitat and environment from localities

One thing that we may be interested in is to get some climatic variables or biome data from localities.
We will do that below with some distribution data from the genus *Myrcia* (Myrtaceae).

```{r}
# Load packages you will need for this workflow:
library(maptools)
library(raster)

# Load function:
source("R/miscellaneous.R")
source("R/GetRanges.R")
source("R/GetTraitDistribution.R")

# Load files you will need for this workflow:
points <- read.csv("example_datasets/points.csv")
```

Now let's get biome and ecoregion data for each point and then a summary for each species:

```{r}
# Gets biomes and eco_region for each point
all_biomes <- localityToBiome(points)
summary_biomes <- getBiomes(all_biomes)

```

If you have environmental variables in raster format, you can extract their values with the following functions.
You can also get some summary statitics for each species with the function **GetClimateSummStats**.

```{r}
# Load layer of predictor
layer <- raster("example_datasets/bio12.bil")
# plot(predictor)
# Get variables from layers
climate_by_point <- ClimateFromPoints(points, layer)
climate_dataset <- GetClimateSummStats(points, layer)

```

## 2. PGLS

Next, we may be interested in understanding whether some trait evolved in a correlated fashion with an environmental factor or biome. There are multiple ways of doing that, but let's start with a simple phylogenetic regression.

```{r}
library(ape)
library(phylolm)
traits <- read.csv("example_datasets/traits.csv")
tree <- read.tree("example_datasets/tree.tre")

# organizing dataset to make sure species names match, etc
combined_dataset <- merge(climate_dataset, traits, by="species")
rownames(combined_dataset) <- combined_dataset$species
combined_dataset$mean <- as.numeric(combined_dataset$mean)

# phylogenetic linear regression
model <- phylolm(B~mean, data=combined_dataset, tree)
summary(model) # here we can get p and r2 values

# and plot points and trend line
plot(combined_dataset$B~combined_dataset$mean) 
abline(model)

```


## 3. Ploting maps

Function GetRanges is a wrapper of dismo::maxent to perform sdms for many species in a more automatized way.

```{r}
all_ranges <- GetRanges(points, species="species", lat="lat", lon="lon", threshold=0.75, buffer=25, res=10) 

# merging ranges with trait data
trait_data <- combined_dataset[,c("species","B")]
trait_data <- subset(trait_data, !is.na(trait_data$B))
all_ranges[!names(all_ranges) %in% trait_data$species] <- NULL

traitB_dist <- GetTraitDistribution(all_ranges, trait_data, type=c("continuous")) 

# we can plot
plot(traitB_dist)
plot(wrld_simpl, add=T)

```

